# Text Curation Pipeline Template
# Generated by CURATOR-OS
#
# This template provides a standard text curation workflow with:
# - Heuristic filtering (15 common filters)
# - Quality classification
# - Fuzzy deduplication reference
#
# Usage:
#   python -m nemo_curator.config.run --config-path=. --config-name=text_curation_template \
#     input_path=/data/raw output_path=/data/curated

defaults:
  - _self_
  - override hydra/job_logging: none
  - override hydra/hydra_logging: none

hydra:
  run:
    dir: .
  output_subdir: null

# Configuration (override on command line)
input_path: ???  # Required: path to input data
output_path: ???  # Required: path for output
cache_path: ${output_path}/.cache
text_field: "text"

# Ray Client Configuration
ray_client:
  _target_: nemo_curator.core.client.RayClient
  num_cpus: null  # Use all available
  num_gpus: 4

# Pipeline Stages
stages:

  # ========================================
  # Stage 1: Read Data
  # ========================================
  - _target_: nemo_curator.stages.text.io.reader.ParquetReader
    file_paths: ${input_path}
    # For JSONL, use:
    # - _target_: nemo_curator.stages.text.io.reader.JsonlReader
    #   file_paths: ${input_path}

  # ========================================
  # Stage 2: Heuristic Filtering
  # ========================================
  
  # Word count filter (50-100K words)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.WordCountFilter
      min_words: 50
      max_words: 100000
    text_field: ${text_field}

  # Non-alphanumeric filter (< 25%)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.NonAlphaNumericFilter
      max_non_alpha_numeric_to_text_ratio: 0.25
    text_field: ${text_field}

  # Symbol ratio filter (< 10%)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.SymbolsToWordsFilter
      max_symbol_to_word_ratio: 0.1
    text_field: ${text_field}

  # URL ratio filter (< 20%)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.UrlsFilter
      max_url_to_text_ratio: 0.2
    text_field: ${text_field}

  # Mean word length filter (3-10 chars)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.MeanWordLengthFilter
      min_mean_word_length: 3
      max_mean_word_length: 10
    text_field: ${text_field}

  # Repeated lines filter (< 30%)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.RepeatedLinesFilter
      max_repeated_line_fraction: 0.3
    text_field: ${text_field}

  # Repeated paragraphs filter (< 30%)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.RepeatedParagraphsFilter
      max_repeated_paragraphs_ratio: 0.3
    text_field: ${text_field}

  # Punctuation filter (< 10%)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.PunctuationFilter
      max_punctuation_ratio: 0.1
    text_field: ${text_field}

  # Common English words filter (min 2)
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.CommonEnglishWordsFilter
      min_num_common_words: 2
    text_field: ${text_field}

  # Pornographic URLs filter
  - _target_: nemo_curator.stages.text.modules.ScoreFilter
    filter_obj:
      _target_: nemo_curator.stages.text.filters.PornographicUrlsFilter
    text_field: ${text_field}

  # ========================================
  # Stage 3: Quality Classification (Optional)
  # ========================================
  # Uncomment to enable quality classification
  
  # - _target_: nemo_curator.stages.text.classifiers.QualityClassifier
  #   batch_size: 64

  # - _target_: nemo_curator.stages.text.classifiers.FineWebEduClassifier
  #   batch_size: 32

  # ========================================
  # Stage 4: Write Output
  # ========================================
  - _target_: nemo_curator.stages.text.io.writer.ParquetWriter
    output_path: ${output_path}

# ========================================
# Deduplication (Run Separately)
# ========================================
# Fuzzy deduplication should be run as a separate workflow.
# Use the /dedup-fuzzy skill to generate the configuration.
#
# Example:
#   python scripts/generate_fuzzy_config.py \
#     --input-path ${output_path} \
#     --output-path ${output_path}/deduped \
#     --cache-path ${cache_path}/dedup
