# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow tests the lock file update process used by dependabot.yml
# It validates that uv lock --upgrade works correctly and creates a TEST PR when changes are detected
# NOTE: This is for testing only - do not merge the created PR

name: Test Lock File Update

on:
  pull_request:
    paths:
      - ".github/workflows/dependabot.yml"
      - ".github/workflows/_update_dependencies.yml"
      - "pyproject.toml"
      - "uv.lock"
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      test-branch: test-lockfile-update-${{ steps.ref.outputs.date }}-${{ steps.ref.outputs.sha }}
      date: ${{ steps.ref.outputs.date }}
    steps:
      - name: Get date and sha
        id: ref
        run: |
          echo "date=$(date +%F)" | tee -a "$GITHUB_OUTPUT"
          echo "sha=$(echo $GITHUB_SHA | cut -c1-7)" | tee -a "$GITHUB_OUTPUT"

  test-lockfile-upgrade:
    needs: [pre-flight]
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.check-changes.outputs.has-changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          submodules: recursive

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create test branch
        env:
          TEST_BRANCH: ${{ needs.pre-flight.outputs.test-branch }}
        run: |
          git checkout -b $TEST_BRANCH main
          git push origin $TEST_BRANCH

      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ needs.pre-flight.outputs.test-branch }}
          submodules: recursive

      - name: Set up uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.12"

      - name: Set environment variables
        run: |
          echo "UV_PROJECT_ENVIRONMENT=./venv" | tee -a "$GITHUB_ENV"
          echo "UV_LINK_MODE=copy" | tee -a "$GITHUB_ENV"

      - name: Test uv lock --upgrade
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ§ª Testing uv lock --upgrade process"
          echo "This simulates what _update_dependencies.yml does"
          
          # Save original lock file for comparison
          cp uv.lock uv.lock.original || echo "No existing lock file"
          
          # Run uv lock --upgrade (same as dependabot workflow)
          uv lock --upgrade
          
          echo "âœ… uv lock --upgrade completed successfully"
          
          # Verify lock file was generated/updated
          if [ -f uv.lock ]; then
            echo "âœ… Lock file exists"
            # Check if lock file is valid (not empty)
            if [ -s uv.lock ]; then
              echo "âœ… Lock file is not empty"
              
              # Check if lock file changed (this is expected behavior)
              if [ -f uv.lock.original ]; then
                if diff -q uv.lock uv.lock.original > /dev/null; then
                  echo "â„¹ï¸ Lock file unchanged (dependencies are up to date)"
                else
                  echo "â„¹ï¸ Lock file was updated (dependencies had updates available)"
                fi
              fi
            else
              echo "âŒ Lock file is empty"
              exit 1
            fi
          else
            echo "âŒ Lock file was not generated"
            exit 1
          fi

      - name: Verify lock file is valid
        run: |
          echo "ğŸ§ª Verifying lock file validity"
          
          # Verify lock file can be checked (validates format)
          uv lock --check && echo "âœ… Lock file is valid and in sync" || echo "âš ï¸ Lock file check completed (may show warnings if dependencies changed)"
          
          echo "âœ… Lock file validation completed"

      - name: Upload lock file
        uses: actions/upload-artifact@v4
        with:
          name: lock-file-${{ needs.pre-flight.outputs.test-branch }}
          path: uv.lock

  create-test-pr:
    needs: [pre-flight, test-lockfile-upgrade]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Download lock file
        uses: actions/download-artifact@v4
        with:
          name: lock-file-${{ needs.pre-flight.outputs.test-branch }}

      - name: Create Test PR
        uses: peter-evans/create-pull-request@v6
        id: create-pull-request
        with:
          branch: ${{ needs.pre-flight.outputs.test-branch }}
          base: main
          title: "ğŸ§ª TEST: Lock file update (${{ needs.pre-flight.outputs.date }}) - DO NOT MERGE"
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ğŸ§ª **THIS IS A TEST PR - DO NOT MERGE** ğŸ§ª
            
            This PR was created by the test-lockfile-update workflow to validate the lock file update process.
            
            **Purpose:**
            - Test that `uv lock --upgrade` works correctly
            - Test that PR creation works end-to-end
            - Validate the workflow matches `_update_dependencies.yml` behavior
            
            **What this validates:**
            - âœ… uv setup works correctly
            - âœ… uv lock --upgrade works in venv
            - âœ… Lock file is generated/updated correctly
            - âœ… Lock file validation works
            - âœ… PR creation works
            
            **Action Required:**
            - âŒ **DO NOT MERGE** - This is for testing only
            - âœ… Review the changes to verify the workflow works
            - âœ… Close this PR after validation
          commit-message: "test: Update lock file (TEST - do not merge)"
          signoff: false
          delete-branch: false

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Lock file update process test completed successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "This test validates:"
          echo "  âœ… uv setup works correctly"
          echo "  âœ… uv lock --upgrade works in venv"
          echo "  âœ… Lock file is generated/updated correctly"
          echo "  âœ… Lock file validation works"
          echo "  âœ… PR creation works end-to-end"
          echo ""
          echo "Test PR created: ${{ steps.create-pull-request.outputs.pull-request-url }}"
          echo ""
          echo "âš ï¸  Remember: This is a TEST PR - do not merge it!"

  summary:
    needs: [pre-flight, test-lockfile-upgrade, create-test-pr]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          if [ "${{ needs.test-lockfile-upgrade.outputs.has-changes }}" == "true" ]; then
            echo "âœ… Lock file had changes - PR should have been created"
          else
            echo "â„¹ï¸ Lock file had no changes - PR creation was skipped (this is expected if dependencies are up to date)"
          fi

