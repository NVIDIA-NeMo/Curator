# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow verifies that the basic install works across all supported platforms.
# Tests lock file installation (reproducible builds) and pip installation (user experience).
# Also tests individual extras in isolation to catch dependency issues early.

name: Installation Test

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"
  schedule:
    - cron: 0 0 * * *

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.event.label.name || 'main' }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  UV_HTTP_TIMEOUT: 60

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.docs_only.outputs.main == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Get changed files
        id: changed-files
        uses: step-security/changed-files@v45.0.1
        with:
          files: |
            nemo_curator/**
            .github/**
            pyproject.toml
            uv.lock
            docker/**
          base_sha: HEAD~1

      - name: Check if docs only
        shell: bash
        id: docs_only
        env:
          DOCS_ONLY: ${{ steps.changed-files.outputs.any_changed == 'false' }}
        run: |
          echo "main=$DOCS_ONLY" | tee -a "$GITHUB_OUTPUT"

  uv-lock-file-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: UV Lock File - Python${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up uv with Python ${{ matrix.python-version }}
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set environment variables
        run: |
          echo "UV_PROJECT_ENVIRONMENT=./venv" | tee -a "$GITHUB_ENV"
          echo "UV_LINK_MODE=copy" | tee -a "$GITHUB_ENV"

      - name: Test lock file installation (containers & source)
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "ğŸ§ª Testing lock file installation with Python ${{ matrix.python-version }}"
          echo "This ensures reproducible builds using uv.lock"
          
          # Test lock file installation with CPU-only extras to avoid CUDA dependencies on CPU runners
          # The Dockerfile uses --extra all, but that requires CUDA which isn't available on ubuntu-latest
          uv sync --link-mode copy --locked --extra audio_cpu --extra image_cpu --extra text_cpu --extra video_cpu --all-groups
          
          # Verify Python version
          uv run python --version
          uv run python -c "import sys; expected = tuple(map(int, '${{ matrix.python-version }}'.split('.'))); assert sys.version_info[:2] == expected, f'Expected Python ${{ matrix.python-version }}, got {sys.version_info[:2]}'"
          
          # Verify installation
          uv run python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator version: {package_info.__version__}')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Installation successful: Lock file installation successful with uv + Python ${{ matrix.python-version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify installation
        shell: bash -x -e -u -o pipefail {0}
        run: |
          uv run python -c "import nemo_curator; print('âœ… nemo_curator imported successfully')"
          uv run python -c "from nemo_curator import package_info; print(f'âœ… Package info: {package_info.__version__}')"

  pip-install-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: Pip Install - Python${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        shell: bash -x -e -u -o pipefail {0}
        run: |
          python -m pip install --upgrade pip

      - name: Install nemo_curator via pip
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "ğŸ§ª Testing pip install nemo_curator"
          echo "This resolves dependencies at runtime and catches user issues"
          
          # Install the package via pip (this is what users will do)
          pip install --no-cache-dir .
          
          echo "âœ… pip install completed"

      - name: Verify pip installation
        shell: bash -x -e -u -o pipefail {0}
        run: |
          python -c "import nemo_curator; print('âœ… nemo_curator imported successfully')"
          python -c "from nemo_curator import package_info; print(f'âœ… Package info: {package_info.__version__}')"
          
          # Verify pip can find the package
          pip show nemo-curator

  # ============================================================================
  # Individual Extras Testing - UV Lock File
  # Tests each CPU extra in isolation to catch dependency conflicts
  # ============================================================================
  extras-isolation-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: UV Extra (${{ matrix.extra }}) - Py${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
        extra: [audio_cpu, image_cpu, text_cpu, video_cpu]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost

      - name: Set up uv with Python ${{ matrix.python-version }}
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Test lock file with extra
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "ğŸ§ª Testing: uv sync --locked --extra ${{ matrix.extra }}"
          uv sync --link-mode copy --locked --extra ${{ matrix.extra }}
          
          # Verify base import
          uv run python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator v{package_info.__version__}')"

      - name: Smoke test extra
        shell: bash -x -e -u -o pipefail {0}
        run: |
          case "${{ matrix.extra }}" in
            audio_cpu)
              uv run python -c "from nemo.collections.asr.models import ASRModel; print('âœ… ASRModel importable')"
              ;;
            image_cpu)
              uv run python -c "import torchvision; print(f'âœ… torchvision {torchvision.__version__} importable')"
              ;;
            text_cpu)
              uv run python -c "import fasttext; print('âœ… fasttext importable')"
              uv run python -c "import trafilatura; print('âœ… trafilatura importable')"
              uv run python -c "import justext; print('âœ… justext importable')"
              ;;
            video_cpu)
              uv run python -c "import av; print(f'âœ… av (PyAV) {av.__version__} importable')"
              uv run python -c "import cv2; print(f'âœ… opencv {cv2.__version__} importable')"
              uv run python -c "import einops; print('âœ… einops importable')"
              ;;
          esac

  # ============================================================================
  # Individual Extras Testing - Pip (User Experience)
  # Tests pip install with extras - this is what users actually do
  # ============================================================================
  pip-extras-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: Pip Extra (${{ matrix.extra }}) - Py${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
        extra: [audio_cpu, image_cpu, text_cpu, video_cpu]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install via pip with extra
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "ğŸ§ª Testing: pip install .[${{ matrix.extra }}]"
          python -m pip install --upgrade pip
          pip install --no-cache-dir ".[${{ matrix.extra }}]"
          
          # Verify installation
          python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator v{package_info.__version__}')"
          pip show nemo-curator

      - name: Smoke test extra
        shell: bash -x -e -u -o pipefail {0}
        run: |
          case "${{ matrix.extra }}" in
            audio_cpu)
              python -c "from nemo.collections.asr.models import ASRModel; print('âœ… ASRModel importable')"
              ;;
            image_cpu)
              python -c "import torchvision; print(f'âœ… torchvision {torchvision.__version__} importable')"
              ;;
            text_cpu)
              python -c "import fasttext; print('âœ… fasttext importable')"
              python -c "import trafilatura; print('âœ… trafilatura importable')"
              ;;
            video_cpu)
              python -c "import av; print(f'âœ… av (PyAV) {av.__version__} importable')"
              python -c "import cv2; print(f'âœ… opencv {cv2.__version__} importable')"
              ;;
          esac

  # ============================================================================
  # CUDA Extras Testing (GPU Runner)
  # Tests GPU-dependent extras on self-hosted runner with CUDA
  # ============================================================================
  extras-cuda-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: self-hosted-nemo
    name: CUDA Extra (${{ matrix.extra }})
    strategy:
      fail-fast: false
      matrix:
        extra: [cuda12, deduplication_cuda12, audio_cuda12, image_cuda12, text_cuda12, video_cuda12, all]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build test container
        run: |
          echo "ğŸ§ª Building container for CUDA extra: ${{ matrix.extra }}"
          docker build -f docker/Dockerfile -t test-${{ matrix.extra }}-${{ github.run_id }} .

      - name: Verify CUDA availability
        run: |
          docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
            python -c "import torch; assert torch.cuda.is_available(), 'CUDA not available'; print(f'âœ… CUDA available, device: {torch.cuda.get_device_name(0)}')"

      - name: Smoke test CUDA imports
        run: |
          case "${{ matrix.extra }}" in
            cuda12)
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import gpustat; print('âœ… gpustat importable')"
              ;;
            deduplication_cuda12)
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import cudf; print(f'âœ… cudf {cudf.__version__} importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import cuml; print(f'âœ… cuml {cuml.__version__} importable')"
              ;;
            audio_cuda12)
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "from nemo.collections.asr.models import ASRModel; print('âœ… ASRModel importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import gpustat; print('âœ… gpustat importable')"
              ;;
            image_cuda12)
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import torchvision; print(f'âœ… torchvision {torchvision.__version__} importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import nvidia.dali; print('âœ… nvidia-dali importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import cudf; print(f'âœ… cudf {cudf.__version__} importable')"
              ;;
            text_cuda12)
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import fasttext; print('âœ… fasttext importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import cudf; import cuml; print('âœ… cudf/cuml importable')"
              ;;
            video_cuda12)
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import av; print(f'âœ… av {av.__version__} importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import cvcuda; print('âœ… cvcuda importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import vllm; print('âœ… vllm importable')"
              ;;
            all)
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "import cudf; import cuml; import torchvision; print('âœ… all extras importable')"
              docker run --rm --gpus all test-${{ matrix.extra }}-${{ github.run_id }} \
                python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator v{package_info.__version__}')"
              ;;
          esac

      - name: Cleanup
        if: always()
        run: |
          docker rmi test-${{ matrix.extra }}-${{ github.run_id }} || true

  # ============================================================================
  # Summary Job
  # ============================================================================
  install-test-summary:
    needs: [pre-flight, uv-lock-file-test, pip-install-test, extras-isolation-test, pip-extras-test, extras-cuda-test]
    runs-on: ubuntu-latest
    name: Install test summary
    if: |
      (
        needs.pre-flight.outputs.docs_only == 'true'
        || always()
      )
      && !cancelled()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get workflow result
        id: result
        shell: bash -x -e -u -o pipefail {0}
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.run_id }}
          SKIPPING_IS_ALLOWED: ${{ needs.pre-flight.outputs.docs_only == 'true' }}
        run: |
          FAILED_JOBS=$(gh run view $RUN_ID --json jobs --jq '[.jobs[] | select(.status == "completed" and .conclusion != "success")] | length') || echo 0

          if [ "${FAILED_JOBS:-0}" -eq 0 ] || [ "$SKIPPING_IS_ALLOWED" == "true" ]; then
              echo "âœ… All installation tests completed successfully"
              echo ""
              echo "ğŸ“Š Test Summary:"
              echo "  - UV Lock File: âœ…"
              echo "  - Pip Install: âœ…"
              echo "  - UV Extras (isolated): âœ…"
              echo "  - Pip Extras: âœ…"
              echo "  - CUDA Extras: âœ…"
              exit 0
          else
              echo "âŒ Found $FAILED_JOBS failed installation test(s)"
              echo ""
              echo "Failed jobs:"
              gh run view $RUN_ID --json jobs --jq '.jobs[] | select(.status == "completed" and .conclusion != "success") | .name'
              exit 1
          fi
