# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow validates NeMo Curator installation for each optional dependency.
# Tests both pip and uv (lockfile) installations.
# - Most jobs: CPU runner, install-only validation
# - UV Py3.12 jobs: GPU runner, install + import validation

name: Installation Test

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  UV_HTTP_TIMEOUT: 60

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.docs_only.outputs.result }}
      cuda_base_image: ${{ steps.cuda_config.outputs.base_image }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: step-security/changed-files@v45.0.1
        with:
          files: |
            nemo_curator/**
            .github/**
            pyproject.toml
            uv.lock
            docker/**
          base_sha: HEAD~1

      - name: Check if docs only
        id: docs_only
        run: echo "result=${{ steps.changed-files.outputs.any_changed == 'false' }}" >> $GITHUB_OUTPUT

      - name: Extract CUDA config
        id: cuda_config
        run: |
          CUDA_VER=$(grep -E "^ARG CUDA_VER=" docker/Dockerfile | cut -d'=' -f2)
          LINUX_VER=$(grep -E "^ARG LINUX_VER=" docker/Dockerfile | cut -d'=' -f2)
          echo "base_image=nvidia/cuda:${CUDA_VER}-cudnn-devel-${LINUX_VER}" >> $GITHUB_OUTPUT

  # ============================================================================
  # CPU Extras - Install Only (CPU Runner)
  # ============================================================================
  cpu-install-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    name: CPU Extras Individual - Install + Import (${{ matrix.installer }}) - Py3.12
    strategy:
      fail-fast: false
      matrix:
        installer: [pip, uv]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        if: matrix.installer == 'uv'
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.12"

      - name: Test each CPU extra (pip)
        if: matrix.installer == 'pip'
        run: |
          CPU_EXTRAS=("audio_cpu" "image_cpu" "text_cpu" "video_cpu")
          RESULTS=""
          FAILED=0
          
          for extra in "${CPU_EXTRAS[@]}"; do
            echo "::group::üì¶ Testing: $extra (pip)"
            
            python -m venv "venv_$extra"
            source "venv_$extra/bin/activate"
            pip install --upgrade pip -q
            
            INSTALL_OK=false
            IMPORT_OK=false
            
            if pip install ".[$extra]" 2>&1; then
              echo "‚úÖ $extra: INSTALL SUCCESS"
              INSTALL_OK=true
              
              if python -c "from nemo_curator import package_info; print(f'  nemo_curator v{package_info.__version__}')"; then
                echo "‚úÖ $extra: IMPORT SUCCESS"
                IMPORT_OK=true
              else
                echo "‚ùå $extra: IMPORT FAILED"
              fi
            else
              echo "‚ùå $extra: INSTALL FAILED"
            fi
            
            if $INSTALL_OK && $IMPORT_OK; then
              RESULTS="$RESULTS\n| $extra | ‚úÖ | ‚úÖ |"
            else
              RESULTS="$RESULTS\n| $extra | $($INSTALL_OK && echo '‚úÖ' || echo '‚ùå') | $($IMPORT_OK && echo '‚úÖ' || echo '‚ùå') |"
              FAILED=$((FAILED + 1))
            fi
            
            deactivate
            rm -rf "venv_$extra"
            echo "::endgroup::"
          done
          
          echo ""
          echo "## CPU Installation Results (pip)"
          echo "| Extra | Install | Import |"
          echo "|-------|---------|--------|"
          echo -e "$RESULTS"
          
          [ $FAILED -gt 0 ] && exit 1 || exit 0

      - name: Test each CPU extra (uv)
        if: matrix.installer == 'uv'
        run: |
          CPU_EXTRAS=("audio_cpu" "image_cpu" "text_cpu" "video_cpu")
          RESULTS=""
          FAILED=0
          
          for extra in "${CPU_EXTRAS[@]}"; do
            echo "::group::üì¶ Testing: $extra (uv)"
            
            rm -rf .venv
            uv cache clean
            
            INSTALL_OK=false
            IMPORT_OK=false
            
            if uv sync --locked --link-mode copy --extra "$extra" 2>&1; then
              echo "‚úÖ $extra: INSTALL SUCCESS"
              INSTALL_OK=true
              
              if uv run python -c "from nemo_curator import package_info; print(f'  nemo_curator v{package_info.__version__}')"; then
                echo "‚úÖ $extra: IMPORT SUCCESS"
                IMPORT_OK=true
              else
                echo "‚ùå $extra: IMPORT FAILED"
              fi
            else
              echo "‚ùå $extra: INSTALL FAILED"
            fi
            
            if $INSTALL_OK && $IMPORT_OK; then
              RESULTS="$RESULTS\n| $extra | ‚úÖ | ‚úÖ |"
            else
              RESULTS="$RESULTS\n| $extra | $($INSTALL_OK && echo '‚úÖ' || echo '‚ùå') | $($IMPORT_OK && echo '‚úÖ' || echo '‚ùå') |"
              FAILED=$((FAILED + 1))
            fi
            
            rm -rf .venv
            uv cache clean
            echo "::endgroup::"
          done
          
          echo ""
          echo "## CPU Installation Results (uv)"
          echo "| Extra | Install | Import |"
          echo "|-------|---------|--------|"
          echo -e "$RESULTS"
          
          [ $FAILED -gt 0 ] && exit 1 || exit 0

  # ============================================================================
  # GPU Extras - Install Only (CPU Runner, Docker build only)
  # ============================================================================
  gpu-install-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    name: GPU Extras Individual - Install Only (${{ matrix.installer }}) - Py3.12
    strategy:
      fail-fast: false
      matrix:
        installer: [pip, uv]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          df -h

      - name: Test each GPU extra (pip)
        if: matrix.installer == 'pip'
        run: |
          GPU_EXTRAS=("cuda12" "deduplication_cuda12" "audio_cuda12" "image_cuda12" "text_cuda12" "video_cuda12")
          BASE_IMAGE="${{ needs.pre-flight.outputs.cuda_base_image }}"
          RESULTS=""
          FAILED=0
          
          for extra in "${GPU_EXTRAS[@]}"; do
            echo "::group::üéÆ Testing: $extra (pip) - Install Only"
            echo "Base image: $BASE_IMAGE"
            
            CONTAINER_NAME="test-pip-$extra-${{ github.run_id }}"
            
            if docker build -f - -t "$CONTAINER_NAME" . <<EOF
          FROM $BASE_IMAGE
          ENV DEBIAN_FRONTEND=noninteractive
          ENV PIP_BREAK_SYSTEM_PACKAGES=1
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python3.12 python3.12-venv python3.12-dev python3-pip git curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
              rm -rf /var/lib/apt/lists/*
          WORKDIR /workspace
          COPY . .
          RUN pip install --no-cache-dir ".[$extra]"
          EOF
            then
              echo "‚úÖ $extra: INSTALL SUCCESS"
              RESULTS="$RESULTS\n| $extra | ‚úÖ |"
            else
              echo "‚ùå $extra: INSTALL FAILED"
              RESULTS="$RESULTS\n| $extra | ‚ùå |"
              FAILED=$((FAILED + 1))
            fi
            
            docker rmi "$CONTAINER_NAME" 2>/dev/null || true
            docker system prune -f 2>/dev/null || true
            echo "::endgroup::"
          done
          
          echo ""
          echo "## GPU Installation Results (pip)"
          echo "| Extra | Install |"
          echo "|-------|---------|"
          echo -e "$RESULTS"
          
          [ $FAILED -gt 0 ] && exit 1 || exit 0

      - name: Test each GPU extra (uv)
        if: matrix.installer == 'uv'
        run: |
          GPU_EXTRAS=("cuda12" "deduplication_cuda12" "audio_cuda12" "image_cuda12" "text_cuda12" "video_cuda12")
          BASE_IMAGE="${{ needs.pre-flight.outputs.cuda_base_image }}"
          RESULTS=""
          FAILED=0
          
          for extra in "${GPU_EXTRAS[@]}"; do
            echo "::group::üéÆ Testing: $extra (uv) - Install Only"
            echo "Base image: $BASE_IMAGE"
            
            CONTAINER_NAME="test-uv-$extra-${{ github.run_id }}"
            
            if docker build -f - -t "$CONTAINER_NAME" . <<EOF
          FROM $BASE_IMAGE
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python3.12 python3.12-venv python3.12-dev git curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
              rm -rf /var/lib/apt/lists/*
          RUN curl -LsSf https://astral.sh/uv/install.sh | sh
          ENV PATH="/root/.local/bin:\$PATH"
          WORKDIR /workspace
          COPY . .
          RUN uv sync --locked --link-mode copy --extra $extra
          EOF
            then
              echo "‚úÖ $extra: INSTALL SUCCESS"
              RESULTS="$RESULTS\n| $extra | ‚úÖ |"
            else
              echo "‚ùå $extra: INSTALL FAILED"
              RESULTS="$RESULTS\n| $extra | ‚ùå |"
              FAILED=$((FAILED + 1))
            fi
            
            docker rmi "$CONTAINER_NAME" 2>/dev/null || true
            docker system prune -f 2>/dev/null || true
            echo "::endgroup::"
          done
          
          echo ""
          echo "## GPU Installation Results (uv)"
          echo "| Extra | Install |"
          echo "|-------|---------|"
          echo -e "$RESULTS"
          
          [ $FAILED -gt 0 ] && exit 1 || exit 0

  # ============================================================================
  # ALL Extras - Install Only (CPU Runner)
  # ============================================================================
  all-install-only-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    name: ALL Extras - Install Only (${{ matrix.installer }}) - Py${{ matrix.python-version }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        installer: [pip, uv]
        python-version: ["3.12", "3.10"]
        exclude:
          - installer: uv
            python-version: "3.12"  # This combo runs on GPU with import checks
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          df -h

      - name: Install ALL extras (pip)
        if: matrix.installer == 'pip'
        id: install-pip
        continue-on-error: true
        run: |
          BASE_IMAGE="${{ needs.pre-flight.outputs.cuda_base_image }}"
          CONTAINER_NAME="test-pip-all-py${{ matrix.python-version }}-${{ github.run_id }}"
          
          echo "::group::üöÄ Installing ALL extras (pip, Py${{ matrix.python-version }}) - Install Only"
          
          docker build -f - -t "$CONTAINER_NAME" . 2>&1 | tee build.log <<EOF
          FROM $BASE_IMAGE
          ENV DEBIAN_FRONTEND=noninteractive
          ENV PIP_BREAK_SYSTEM_PACKAGES=1
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python${{ matrix.python-version }} python${{ matrix.python-version }}-venv python${{ matrix.python-version }}-dev python3-pip git curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.python-version }} 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.python-version }} 1 && \
              rm -rf /var/lib/apt/lists/*
          WORKDIR /workspace
          COPY . .
          RUN pip install --no-cache-dir ".[all]"
          EOF
          
          [ $? -eq 0 ] && echo "‚úÖ INSTALL SUCCESS" || echo "‚ùå INSTALL FAILED (expected - known conflicts)"
          echo "::endgroup::"
          
          docker rmi "$CONTAINER_NAME" 2>/dev/null || true

      - name: Install ALL extras (uv)
        if: matrix.installer == 'uv'
        id: install-uv
        continue-on-error: true
        run: |
          BASE_IMAGE="${{ needs.pre-flight.outputs.cuda_base_image }}"
          CONTAINER_NAME="test-uv-all-py${{ matrix.python-version }}-${{ github.run_id }}"
          
          echo "::group::üöÄ Installing ALL extras (uv, Py${{ matrix.python-version }}) - Install Only"
          
          docker build -f - -t "$CONTAINER_NAME" . 2>&1 | tee build.log <<EOF
          FROM $BASE_IMAGE
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python${{ matrix.python-version }} python${{ matrix.python-version }}-venv python${{ matrix.python-version }}-dev git curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.python-version }} 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.python-version }} 1 && \
              rm -rf /var/lib/apt/lists/*
          RUN curl -LsSf https://astral.sh/uv/install.sh | sh
          ENV PATH="/root/.local/bin:\$PATH"
          WORKDIR /workspace
          COPY . .
          RUN uv sync --locked --link-mode copy --extra all
          EOF
          
          [ $? -eq 0 ] && echo "‚úÖ INSTALL SUCCESS" || echo "‚ùå INSTALL FAILED (expected - known conflicts)"
          echo "::endgroup::"
          
          docker rmi "$CONTAINER_NAME" 2>/dev/null || true

      - name: Report
        if: always()
        run: |
          echo "üìä ALL Extras (${{ matrix.installer }}, Py${{ matrix.python-version }}) - Install Only"
          echo "Known conflicts may cause failure. See build logs for details."

  # ============================================================================
  # ALL Extras - Install + Import (GPU Runner, uv Py3.12 only)
  # ============================================================================
  all-install-import-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: self-hosted-nemo
    name: ALL Extras - Install + Import (uv) - Py3.12
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ALL extras (uv - install + import)
        id: install
        continue-on-error: true
        run: |
          BASE_IMAGE="${{ needs.pre-flight.outputs.cuda_base_image }}"
          CONTAINER_NAME="test-uv-all-py3.12-${{ github.run_id }}"
          
          echo "::group::üöÄ Installing ALL extras (uv, Py3.12) - Install + Import"
          
          docker build -f - -t "$CONTAINER_NAME" . 2>&1 | tee build.log <<EOF
          FROM $BASE_IMAGE
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python3.12 python3.12-venv python3.12-dev git curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
              rm -rf /var/lib/apt/lists/*
          RUN curl -LsSf https://astral.sh/uv/install.sh | sh
          ENV PATH="/root/.local/bin:\$PATH"
          WORKDIR /workspace
          COPY . .
          RUN uv sync --locked --link-mode copy --extra all
          EOF
          
          if [ $? -eq 0 ]; then
            echo "install_status=success" >> $GITHUB_OUTPUT
            echo "container=$CONTAINER_NAME" >> $GITHUB_OUTPUT
          else
            echo "install_status=failure" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Verify imports
        if: steps.install.outputs.install_status == 'success'
        run: |
          CONTAINER="${{ steps.install.outputs.container }}"
          
          echo "::group::üîç Import Verification"
          docker run --rm --gpus all "$CONTAINER" uv run python -c "
          import sys
          print('Python:', sys.version)
          
          from nemo_curator import package_info
          print(f'‚úÖ nemo_curator v{package_info.__version__}')
          
          try:
              import torch
              print(f'‚úÖ torch {torch.__version__} (CUDA: {torch.cuda.is_available()})')
          except Exception as e:
              print(f'‚ö†Ô∏è torch: {e}')
          
          try:
              import cudf, cuml
              print('‚úÖ cudf, cuml')
          except Exception as e:
              print(f'‚ö†Ô∏è cudf/cuml: {e}')
          
          try:
              import torchvision
              print(f'‚úÖ torchvision {torchvision.__version__}')
          except Exception as e:
              print(f'‚ö†Ô∏è torchvision: {e}')
          "
          echo "::endgroup::"

      - name: Report
        if: always()
        run: |
          echo ""
          echo "=============================================="
          echo "üìä ALL EXTRAS (uv, Py3.12) - Install + Import"
          echo "=============================================="
          
          if [ "${{ steps.install.outputs.install_status }}" == "success" ]; then
            echo "‚úÖ Install: SUCCESS"
          else
            echo "‚ùå Install: FAILED (expected - known conflicts)"
            echo ""
            echo "Known conflicts:"
            echo "  - nemo_toolkit[asr] requires transformers<4.55"
            echo "  - vllm requires transformers>=4.55"
            grep -E "(ResolutionImpossible|ERROR:|versions have conflicting|incompatible)" build.log | head -10 || true
          fi

      - name: Cleanup
        if: always()
        run: docker rmi "test-uv-all-py3.12-${{ github.run_id }}" 2>/dev/null || true

  # ============================================================================
  # Summary
  # ============================================================================
  install-test-summary:
    needs: [pre-flight, cpu-install-test, gpu-install-test, all-install-only-test, all-install-import-test]
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    steps:
      - name: Summary
        run: |
          echo "# üìä Installation Test Summary"
          echo ""
          echo "## Individual Extras"
          echo "| Job | Runner | Installer | Validation | Status |"
          echo "|-----|--------|-----------|------------|--------|"
          echo "| CPU Extras | CPU | pip | Install+Import | ${{ needs.cpu-install-test.result == 'success' && '‚úÖ' || '‚ùå' }} |"
          echo "| CPU Extras | CPU | uv | Install+Import | ${{ needs.cpu-install-test.result == 'success' && '‚úÖ' || '‚ùå' }} |"
          echo "| GPU Extras | CPU | pip | Install Only | ${{ needs.gpu-install-test.result == 'success' && '‚úÖ' || '‚ùå' }} |"
          echo "| GPU Extras | CPU | uv | Install Only | ${{ needs.gpu-install-test.result == 'success' && '‚úÖ' || '‚ùå' }} |"
          echo ""
          echo "## ALL Extras (Combined)"
          echo "| Job | Runner | Validation | Status |"
          echo "|-----|--------|------------|--------|"
          echo "| ALL (pip/uv, Py3.10/3.12) | CPU | Install Only | ${{ needs.all-install-only-test.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |"
          echo "| ALL (uv, Py3.12) | **GPU** | **Install+Import** | ${{ needs.all-install-import-test.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |"
          echo ""
          
          # Core tests (individual extras) must pass
          if [ "${{ needs.cpu-install-test.result }}" != "success" ] || \
             [ "${{ needs.gpu-install-test.result }}" != "success" ]; then
            echo "‚ùå Core installation tests failed"
            exit 1
          else
            echo "‚úÖ All individual extras validated successfully"
          fi

