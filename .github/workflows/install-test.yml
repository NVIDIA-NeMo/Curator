# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow validates NeMo Curator installation across supported platforms.
# Tests both uv (lock file) and pip installations for CPU and ALL (GPU+CPU) extras.

name: Installation Test

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"
  schedule:
    - cron: 0 0 * * *

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.event.label.name || 'main' }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  UV_HTTP_TIMEOUT: 60
  # GPU test configuration - update here when upgrading CUDA
  CUDA_VERSION: "12.8"  # For display in job names
  CUDA_BASE_IMAGE: "nvidia/cuda:12.8.1-cudnn-devel-ubuntu24.04"

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.docs_only.outputs.main == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Get changed files
        id: changed-files
        uses: step-security/changed-files@v45.0.1
        with:
          files: |
            nemo_curator/**
            .github/**
            pyproject.toml
            uv.lock
            docker/**
          base_sha: HEAD~1

      - name: Check if docs only
        shell: bash
        id: docs_only
        env:
          DOCS_ONLY: ${{ steps.changed-files.outputs.any_changed == 'false' }}
        run: |
          echo "main=$DOCS_ONLY" | tee -a "$GITHUB_OUTPUT"

  # ============================================================================
  # CPU Installation Tests (ubuntu-latest)
  # ============================================================================
  uv-cpu-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: UV CPU - Py${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost

      - name: Set up uv with Python ${{ matrix.python-version }}
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install with uv (CPU extras)
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "ðŸ§ª Testing: uv sync --locked (all CPU extras)"
          uv sync --link-mode copy --locked --extra audio_cpu --extra image_cpu --extra text_cpu --extra video_cpu
          
          # Verify Python version
          uv run python --version
          uv run python -c "import sys; expected = tuple(map(int, '${{ matrix.python-version }}'.split('.'))); assert sys.version_info[:2] == expected"

      - name: Verify installation
        shell: bash -x -e -u -o pipefail {0}
        run: |
          uv run python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator v{package_info.__version__}')"
          uv run python -c "import torchvision; print(f'âœ… torchvision {torchvision.__version__}')"
          uv run python -c "import fasttext; print('âœ… fasttext')"
          uv run python -c "import av; print(f'âœ… av {av.__version__}')"

  pip-cpu-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: Pip CPU - Py${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install with pip (CPU extras)
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "ðŸ§ª Testing: pip install .[audio_cpu,image_cpu,text_cpu,video_cpu]"
          python -m pip install --upgrade pip
          pip install --no-cache-dir ".[audio_cpu,image_cpu,text_cpu,video_cpu]"

      - name: Verify installation
        shell: bash -x -e -u -o pipefail {0}
        run: |
          python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator v{package_info.__version__}')"
          python -c "import torchvision; print(f'âœ… torchvision {torchvision.__version__}')"
          python -c "import fasttext; print('âœ… fasttext')"
          python -c "import av; print(f'âœ… av {av.__version__}')"
          pip show nemo-curator

  # ============================================================================
  # GPU Installation Tests (self-hosted with CUDA)
  # Tests 'all' extra which includes CPU + GPU dependencies
  # ============================================================================
  uv-all-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: self-hosted-nemo
    name: UV All (CPU+GPU) - CUDA${{ env.CUDA_VERSION }} - Py${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build and test container (uv)
        run: |
          echo "ðŸ§ª Testing: uv sync --locked --extra all (Python ${{ matrix.python-version }})"
          
          # Build container with deadsnakes PPA for Python 3.10 support
          docker build -f - -t test-uv-all-${{ matrix.python-version }}-${{ github.run_id }} . <<EOF
          FROM ${{ env.CUDA_BASE_IMAGE }}
          
          ENV DEBIAN_FRONTEND=noninteractive
          
          # Install Python (with deadsnakes PPA for 3.10 support)
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python${{ matrix.python-version }} \
              python${{ matrix.python-version }}-venv \
              python${{ matrix.python-version }}-dev \
              git \
              curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.python-version }} 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.python-version }} 1 && \
              rm -rf /var/lib/apt/lists/*
          
          # Install uv
          RUN curl -LsSf https://astral.sh/uv/install.sh | sh
          ENV PATH="/root/.local/bin:\$PATH"
          
          WORKDIR /workspace
          COPY . .
          RUN uv sync --locked --link-mode copy --extra all
          EOF

      - name: Verify CUDA and imports
        run: |
          docker run --rm --gpus all test-uv-all-${{ matrix.python-version }}-${{ github.run_id }} \
            python -c "import torch; assert torch.cuda.is_available(), 'CUDA not available'; print(f'âœ… CUDA: {torch.cuda.get_device_name(0)}')"
          
          docker run --rm --gpus all test-uv-all-${{ matrix.python-version }}-${{ github.run_id }} \
            python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator v{package_info.__version__}')"
          
          docker run --rm --gpus all test-uv-all-${{ matrix.python-version }}-${{ github.run_id }} \
            python -c "import cudf; import cuml; print('âœ… cudf, cuml')"
          
          docker run --rm --gpus all test-uv-all-${{ matrix.python-version }}-${{ github.run_id }} \
            python -c "import torchvision; print(f'âœ… torchvision {torchvision.__version__}')"

      - name: Cleanup
        if: always()
        run: |
          docker rmi test-uv-all-${{ matrix.python-version }}-${{ github.run_id }} || true

  pip-all-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: self-hosted-nemo
    name: Pip All (CPU+GPU) - CUDA${{ env.CUDA_VERSION }} - Py${{ matrix.python-version }}
    # Allow failure due to known dependency conflict: nemo_toolkit[asr] vs vllm (transformers version)
    # TODO: Fix in pyproject.toml when nemo_toolkit supports transformers>=4.55.2
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build and test container (pip)
        run: |
          echo "ðŸ§ª Testing: pip install .[all] (Python ${{ matrix.python-version }})"
          
          # Build container with deadsnakes PPA for Python 3.10 support
          docker build -f - -t test-pip-all-${{ matrix.python-version }}-${{ github.run_id }} . <<EOF
          FROM ${{ env.CUDA_BASE_IMAGE }}
          
          ENV DEBIAN_FRONTEND=noninteractive
          ENV PIP_BREAK_SYSTEM_PACKAGES=1
          
          # Install Python (matching project's Dockerfile setup)
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python${{ matrix.python-version }} \
              python${{ matrix.python-version }}-venv \
              python${{ matrix.python-version }}-dev \
              python3-pip \
              git \
              curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.python-version }} 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.python-version }} 1 && \
              rm -rf /var/lib/apt/lists/*
          
          # Upgrade pip
          RUN python -m pip install --upgrade pip
          
          WORKDIR /workspace
          COPY . .
          RUN pip install --no-cache-dir ".[all]"
          EOF

      - name: Verify CUDA and imports
        run: |
          docker run --rm --gpus all test-pip-all-${{ matrix.python-version }}-${{ github.run_id }} \
            python -c "import torch; assert torch.cuda.is_available(), 'CUDA not available'; print(f'âœ… CUDA: {torch.cuda.get_device_name(0)}')"
          
          docker run --rm --gpus all test-pip-all-${{ matrix.python-version }}-${{ github.run_id }} \
            python -c "from nemo_curator import package_info; print(f'âœ… nemo_curator v{package_info.__version__}')"
          
          docker run --rm --gpus all test-pip-all-${{ matrix.python-version }}-${{ github.run_id }} \
            python -c "import cudf; import cuml; print('âœ… cudf, cuml')"

      - name: Cleanup
        if: always()
        run: |
          docker rmi test-pip-all-${{ matrix.python-version }}-${{ github.run_id }} || true

  # ============================================================================
  # Summary
  # ============================================================================
  install-test-summary:
    needs: [pre-flight, uv-cpu-test, pip-cpu-test, uv-all-test, pip-all-test]
    runs-on: ubuntu-latest
    name: Install test summary
    if: |
      (needs.pre-flight.outputs.docs_only == 'true' || always()) && !cancelled()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get workflow result
        id: result
        shell: bash -x -e -u -o pipefail {0}
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.run_id }}
          SKIPPING_IS_ALLOWED: ${{ needs.pre-flight.outputs.docs_only == 'true' }}
        run: |
          FAILED_JOBS=$(gh run view $RUN_ID --json jobs --jq '[.jobs[] | select(.status == "completed" and .conclusion != "success")] | length') || echo 0

          if [ "${FAILED_JOBS:-0}" -eq 0 ] || [ "$SKIPPING_IS_ALLOWED" == "true" ]; then
              echo "âœ… All installation tests passed"
              echo ""
              echo "ðŸ“Š Test Matrix:"
              echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
              echo "  â”‚ Method  â”‚ Py 3.10     â”‚ Py 3.12     â”‚"
              echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
              echo "  â”‚ UV CPU  â”‚ âœ…          â”‚ âœ…          â”‚"
              echo "  â”‚ UV All  â”‚ âœ…          â”‚ âœ…          â”‚"
              echo "  â”‚ Pip CPU â”‚ âœ…          â”‚ âœ…          â”‚"
              echo "  â”‚ Pip All â”‚ âœ…          â”‚ âœ…          â”‚"
              echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
              exit 0
          else
              echo "âŒ Found $FAILED_JOBS failed installation test(s)"
              gh run view $RUN_ID --json jobs --jq '.jobs[] | select(.status == "completed" and .conclusion != "success") | .name'
              exit 1
          fi
