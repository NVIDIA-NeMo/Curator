# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow validates NeMo Curator installation for each optional dependency.
# Tests both pip and uv (lockfile) installations.
# - Most jobs: CPU runner, install-only validation
# - UV Py3.12 jobs: GPU runner, install + import validation

name: Installation Test

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  UV_HTTP_TIMEOUT: 300 # 300s timeout needed for large GPU packages (cudf, vllm, flash-attn, torch)

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.docs_only.outputs.result }}
      cuda_base_image: ${{ steps.cuda_config.outputs.base_image }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: get-pr-info
        if: startsWith(github.ref, 'refs/heads/pull-request/')
        uses: nv-gha-runners/get-pr-info@main

      - name: Determine base reference
        id: base-ref
        run: |
          echo "base=${{ (startsWith(github.ref, 'refs/heads/pull-request/') && fromJSON(steps.get-pr-info.outputs.pr-info).base.ref) || 'HEAD~1' }}" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: changed-files
        uses: step-security/changed-files@v45.0.1
        with:
          files: |
            nemo_curator/**
            .github/**
            pyproject.toml
            uv.lock
            docker/**
          base_sha: ${{ steps.base-ref.outputs.base }}

      - name: Check if docs only
        id: docs_only
        run: echo "result=${{ steps.changed-files.outputs.any_changed == 'false' }}" >> $GITHUB_OUTPUT

      - name: Extract CUDA config
        id: cuda_config
        run: |
          CUDA_VER=$(grep -E "^ARG CUDA_VER=" docker/Dockerfile | cut -d'=' -f2)
          LINUX_VER=$(grep -E "^ARG LINUX_VER=" docker/Dockerfile | cut -d'=' -f2)
          echo "base_image=nvidia/cuda:${CUDA_VER}-cudnn-devel-${LINUX_VER}" >> $GITHUB_OUTPUT

  # ============================================================================
  # CPU Extras - Install Only (CPU Runner)
  # ============================================================================
  cpu-install-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    name: CPU Extras Individual - Install + Import (${{ matrix.installer }}) - Py3.12
    strategy:
      fail-fast: false
      matrix:
        installer: [pip, uv]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        if: matrix.installer == 'uv'
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.12"
          enable-cache: false  # We use isolated venvs with uv cache clean

      - name: Test each CPU extra (${{ matrix.installer }})
        run: |
          set -o pipefail
          INSTALLER="${{ matrix.installer }}"
          CPU_EXTRAS=("audio_cpu" "image_cpu" "text_cpu" "video_cpu")
          RESULTS=""
          FAILED=0
          
          for extra in "${CPU_EXTRAS[@]}"; do
            echo "::group::üì¶ Testing: $extra ($INSTALLER)"
            
            # Setup environment
            if [ "$INSTALLER" == "pip" ]; then
              python -m venv "venv_$extra"
              source "venv_$extra/bin/activate"
              pip install --upgrade pip
            else
              rm -rf .venv
              uv cache clean
            fi
            
            INSTALL_OK=false
            IMPORT_OK=false
            
            # Install
            if [ "$INSTALLER" == "pip" ]; then
              INSTALL_CMD="pip install '.[$extra]'"
            else
              INSTALL_CMD="uv sync --locked --link-mode copy --extra $extra"
            fi
            
            if eval "$INSTALL_CMD" 2>&1 | tee "install-$extra.log"; then
              echo "‚úÖ $extra: INSTALL SUCCESS"
              INSTALL_OK=true
              
              # Import test
              if [ "$INSTALLER" == "pip" ]; then
                RUN_CMD="python"
              else
                RUN_CMD="uv run python"
              fi
              
              if $RUN_CMD -c "from nemo_curator import package_info; print(f'  nemo_curator v{package_info.__version__}')" 2>&1 | tee -a "install-$extra.log"; then
                echo "‚úÖ $extra: IMPORT SUCCESS"
                IMPORT_OK=true
              else
                echo "‚ùå $extra: IMPORT FAILED"
              fi
            else
              echo "‚ùå $extra: INSTALL FAILED"
              echo ""
              echo "=== ERROR for $extra ==="
              grep -E "(ERROR:|error:|Cannot install|conflicting dependencies|ResolutionImpossible|No space left|Failed to install)" "install-$extra.log" | tail -15 || tail -30 "install-$extra.log"
              echo "========================="
            fi
            
            if $INSTALL_OK && $IMPORT_OK; then
              RESULTS="$RESULTS\n| $extra | ‚úÖ | ‚úÖ |"
            else
              RESULTS="$RESULTS\n| $extra | $($INSTALL_OK && echo '‚úÖ' || echo '‚ùå') | $($IMPORT_OK && echo '‚úÖ' || echo '‚ùå') |"
              FAILED=$((FAILED + 1))
            fi
            
            # Cleanup
            rm -f "install-$extra.log"
            if [ "$INSTALLER" == "pip" ]; then
              deactivate
              rm -rf "venv_$extra"
            else
              rm -rf .venv
              uv cache clean
            fi
            echo "::endgroup::"
          done
          
          echo ""
          echo "## CPU Installation Results ($INSTALLER)"
          echo "| Extra | Install | Import |"
          echo "|-------|---------|--------|"
          echo -e "$RESULTS"
          
          [ $FAILED -gt 0 ] && exit 1 || exit 0

  # ============================================================================
  # GPU Extras - Install Only (pip=OPTIONAL, uv=Required)
  # ============================================================================
  gpu-install-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: linux-amd64-cpu16
    strategy:
      fail-fast: false
      matrix:
        installer: [pip, uv]
    name: "${{ matrix.installer == 'pip' && 'OPTIONAL: ' || '' }}GPU Extras Individual - Install Only (${{ matrix.installer }}) - Py3.12"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          df -h

      - name: Build base image
        run: |
          BASE_IMAGE="${{ needs.pre-flight.outputs.cuda_base_image }}"
          INSTALLER="${{ matrix.installer }}"
          
          if [ "$INSTALLER" == "pip" ]; then
            EXTRA_ENV="ENV PIP_BREAK_SYSTEM_PACKAGES=1"
            EXTRA_PKGS="python3-pip"
            INSTALL_UV=""
          else
            EXTRA_ENV=""
            EXTRA_PKGS=""
            INSTALL_UV='RUN curl -LsSf https://astral.sh/uv/install.sh | sh
          ENV PATH="/root/.local/bin:$PATH"'
          fi
          
          cat > Dockerfile.gpu-base <<DOCKERFILE
          FROM $BASE_IMAGE
          ENV DEBIAN_FRONTEND=noninteractive
          $EXTRA_ENV
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python3.12 python3.12-venv python3.12-dev $EXTRA_PKGS git curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
              rm -rf /var/lib/apt/lists/*
          $INSTALL_UV
          WORKDIR /workspace
          DOCKERFILE
          docker build -f Dockerfile.gpu-base -t gpu-base-$INSTALLER .
          rm -f Dockerfile.gpu-base

      - name: Test each GPU extra (${{ matrix.installer }})
        id: test
        run: |
          set -o pipefail
          INSTALLER="${{ matrix.installer }}"
          GPU_EXTRAS=("cuda12" "deduplication_cuda12" "audio_cuda12" "image_cuda12" "text_cuda12" "video_cuda12")
          RESULTS=""
          FAILED=0
          
          for extra in "${GPU_EXTRAS[@]}"; do
            echo "::group::üéÆ Testing: $extra ($INSTALLER) - Install Only"
            
            # Set docker options for uv
            DOCKER_OPTS=""
            if [ "$INSTALLER" == "uv" ]; then
              DOCKER_OPTS="-e UV_HTTP_TIMEOUT=300"
            fi
            
            # Run install in isolated container
            if docker run --rm $DOCKER_OPTS -v "$(pwd):/src:ro" gpu-base-$INSTALLER bash -c "
              set -e
              cp -r /src /tmp/workspace
              cd /tmp/workspace
              if [ \"$INSTALLER\" = \"pip\" ]; then
                python -m venv /tmp/test_venv
                source /tmp/test_venv/bin/activate
                pip install --no-cache-dir \".[$extra]\"
              else
                uv sync --locked --link-mode copy --extra $extra
              fi
            " 2>&1 | tee "install-$extra.log"; then
              echo "‚úÖ $extra: INSTALL SUCCESS"
              RESULTS="$RESULTS\n| $extra | ‚úÖ |"
            else
              echo "‚ùå $extra: INSTALL FAILED"
              echo ""
              echo "=== ERROR for $extra ==="
              if [ "$INSTALLER" == "pip" ]; then
                grep -E "(ERROR:|error:|Cannot install|conflicting dependencies|ResolutionImpossible|versions have conflicting)" "install-$extra.log" | tail -15 || tail -30 "install-$extra.log"
              else
                grep -E "(error:|Error:|No space left|Failed to install)" "install-$extra.log" | tail -15 || tail -30 "install-$extra.log"
              fi
              echo "========================="
              RESULTS="$RESULTS\n| $extra | ‚ùå |"
              FAILED=$((FAILED + 1))
            fi
            
            rm -f "install-$extra.log"
            echo "::endgroup::"
          done
          
          echo ""
          echo "## GPU Installation Results ($INSTALLER)"
          echo "| Extra | Status |"
          echo "|-------|--------|"
          echo -e "$RESULTS"
          
          if [ $FAILED -gt 0 ]; then
            echo "test_status=failure" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "test_status=success" >> $GITHUB_OUTPUT
          fi

      - name: Save status for summary
        if: always()
        run: |
          mkdir -p gpu-status
          echo "${{ steps.test.outputs.test_status || 'failure' }}" > gpu-status/${{ matrix.installer }}_status.txt

      - name: Upload status artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-status-${{ matrix.installer }}
          path: gpu-status/
          retention-days: 1

      - name: Cleanup
        if: always()
        run: docker rmi gpu-base-${{ matrix.installer }} 2>/dev/null || true

  # ============================================================================
  # ALL Extras - Install Only (CPU Runner)
  # ============================================================================
  all-install-only-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: linux-amd64-cpu16
    container:
      image: ${{ needs.pre-flight.outputs.cuda_base_image }}
    name: "${{ matrix.installer == 'pip' && 'OPTIONAL: ' || '' }}ALL Extras - Install Only (${{ matrix.installer }}) - Py${{ matrix.python-version }}"
    strategy:
      fail-fast: false
      matrix:
        installer: [pip, uv]
        python-version: ["3.12", "3.10"]
        exclude:
          - installer: uv
            python-version: "3.12"  # This combo runs on GPU with import checks
    steps:
      - name: Install git for checkout
        run: |
          apt-get update && apt-get install -y --no-install-recommends git

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python ${{ matrix.python-version }}
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            software-properties-common
          add-apt-repository -y ppa:deadsnakes/ppa
          apt-get update && apt-get install -y --no-install-recommends \
            python${{ matrix.python-version }} \
            python${{ matrix.python-version }}-venv \
            python${{ matrix.python-version }}-dev \
            git curl
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.python-version }} 1
          update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.python-version }} 1

      - name: Setup pip
        if: matrix.installer == 'pip'
        run: |
          apt-get install -y --no-install-recommends python3-pip
          pip install --upgrade pip || true  # Best-effort upgrade, continue if fails

      - name: Setup uv
        if: matrix.installer == 'uv'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "/root/.local/bin" >> $GITHUB_PATH
        env:
          UV_HTTP_TIMEOUT: 300

      - name: Install ALL extras (${{ matrix.installer }})
        id: install
        shell: bash
        run: |
          set -o pipefail
          echo "üöÄ Installing ALL extras (${{ matrix.installer }}, Py${{ matrix.python-version }})"
          
          if [ "${{ matrix.installer }}" = "pip" ]; then
            if pip install --no-cache-dir ".[all]" 2>&1 | tee install.log; then
              echo "install_status=success" >> $GITHUB_OUTPUT
              echo "‚úÖ INSTALL SUCCESS"
            else
              echo "install_status=failure" >> $GITHUB_OUTPUT
              echo "‚ùå INSTALL FAILED"
              grep -E "(ERROR|error:|failed|conflict)" install.log | head -20 || true
            fi
          else
            export PATH="/root/.local/bin:$PATH"
            if uv sync --locked --link-mode copy --extra all 2>&1 | tee install.log; then
              echo "install_status=success" >> $GITHUB_OUTPUT
              echo "‚úÖ INSTALL SUCCESS"
            else
              echo "install_status=failure" >> $GITHUB_OUTPUT
              echo "‚ùå INSTALL FAILED"
              grep -E "(error:|Error:|failed)" install.log | head -20 || true
            fi
          fi
        env:
          UV_HTTP_TIMEOUT: 300
          PIP_BREAK_SYSTEM_PACKAGES: 1

      - name: Report
        if: always()
        run: |
          echo "üìä ALL Extras (${{ matrix.installer }}, Py${{ matrix.python-version }}) - Install Only"
          
          if [ "${{ steps.install.outputs.install_status }}" = "success" ]; then
            echo "‚úÖ Installation succeeded"
          else
            echo "‚ùå Installation failed (expected - known conflicts)"
            echo ""
            echo "Known conflicts that may cause this:"
            echo "  - nemo_toolkit[asr] requires transformers<4.55 but vllm requires transformers>=4.55"
            echo "  - flash-attn build requires packaging module"
            echo "  - flash-attn build requires torch pre-installed (pip can't handle build-time deps)"
            exit 1
          fi

  # ============================================================================
  # ALL Extras - Install + Import (GPU Runner, uv Py3.12 only)
  # ============================================================================
  all-install-import-test:
    needs: [pre-flight]
    if: needs.pre-flight.outputs.docs_only != 'true'
    runs-on: self-hosted-nemo
    name: "ALL Extras - Install + Import (uv) - Py3.12"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install ALL extras (uv - install + import)
        id: install
        run: |
          set -o pipefail
          BASE_IMAGE="${{ needs.pre-flight.outputs.cuda_base_image }}"
          CONTAINER_NAME="test-uv-all-py3.12-${{ github.run_id }}"
          
          echo "::group::üöÄ Installing ALL extras (uv, Py3.12) - Install + Import"
          
          # Write Dockerfile first to avoid heredoc+pipe issues
          cat > Dockerfile.all-test <<DOCKERFILE
          FROM $BASE_IMAGE
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y --no-install-recommends \
              software-properties-common && \
              add-apt-repository -y ppa:deadsnakes/ppa && \
              apt-get update && apt-get install -y --no-install-recommends \
              python3.12 python3.12-venv python3.12-dev git curl && \
              update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
              update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
              rm -rf /var/lib/apt/lists/*
          RUN curl -LsSf https://astral.sh/uv/install.sh | sh
          ENV PATH="/root/.local/bin:\$PATH"
          ENV UV_HTTP_TIMEOUT=300
          WORKDIR /workspace
          COPY . .
          RUN uv sync --locked --link-mode copy --extra all
          ENV PATH="/workspace/.venv/bin:\$PATH"
          DOCKERFILE
          
          if docker build -f Dockerfile.all-test -t "$CONTAINER_NAME" . 2>&1 | tee build.log; then
            echo "install_status=success" >> $GITHUB_OUTPUT
            echo "container=$CONTAINER_NAME" >> $GITHUB_OUTPUT
          else
            echo "install_status=failure" >> $GITHUB_OUTPUT
            echo ""
            echo "=== Build log errors ==="
            grep -E "(ERROR|error:|failed|conflict)" build.log | head -30 || cat build.log | tail -50
            exit 1
          fi
          echo "::endgroup::"

      - name: Verify imports
        if: steps.install.outputs.install_status == 'success'
        run: |
          CONTAINER="${{ steps.install.outputs.container }}"
          
          echo "::group::üîç Import Verification"
          docker run --rm --gpus all "$CONTAINER" uv run python -c "
          import sys
          print('Python:', sys.version)
          
          from nemo_curator import package_info
          print(f'‚úÖ nemo_curator v{package_info.__version__}')
          
          try:
              import torch
              print(f'‚úÖ torch {torch.__version__} (CUDA: {torch.cuda.is_available()})')
          except Exception as e:
              print(f'‚ö†Ô∏è torch: {e}')
          
          try:
              import cudf, cuml
              print('‚úÖ cudf, cuml')
          except Exception as e:
              print(f'‚ö†Ô∏è cudf/cuml: {e}')
          
          try:
              import torchvision
              print(f'‚úÖ torchvision {torchvision.__version__}')
          except Exception as e:
              print(f'‚ö†Ô∏è torchvision: {e}')
          "
          echo "::endgroup::"

      - name: Report
        if: always()
        run: |
          echo ""
          echo "=============================================="
          echo "üìä ALL EXTRAS (uv, Py3.12) - Install + Import"
          echo "=============================================="
          
          if [ "${{ steps.install.outputs.install_status }}" = "success" ]; then
            echo "‚úÖ Install: SUCCESS"
          else
            echo "‚ùå Install: FAILED"
            echo ""
            echo "Known conflicts that may cause this:"
            echo "  - nemo_toolkit[asr] requires transformers<4.55 but vllm requires transformers>=4.55"
            echo ""
            echo "Build log errors:"
            grep -E "(ResolutionImpossible|ERROR:|versions have conflicting|incompatible)" build.log | head -20 || true
          fi

      - name: Cleanup
        if: always()
        run: docker rmi "test-uv-all-py3.12-${{ github.run_id }}" 2>/dev/null || true

  # ============================================================================
  # Summary
  # ============================================================================
  install-test-summary:
    # Note: all jobs listed to access their .result status
    needs: [pre-flight, cpu-install-test, gpu-install-test, all-install-only-test, all-install-import-test]
    runs-on: ubuntu-latest
    if: ${{ always() && needs.pre-flight.outputs.docs_only != 'true' }}
    steps:
      - name: Download GPU status artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gpu-status-*
          merge-multiple: true
          path: gpu-status/

      - name: Summary
        run: |
          # Read GPU status from artifacts (matrix outputs don't merge across runs)
          GPU_PIP_STATUS=$(cat gpu-status/pip_status.txt 2>/dev/null || echo "failure")
          GPU_UV_STATUS=$(cat gpu-status/uv_status.txt 2>/dev/null || echo "failure")
          
          echo "# üìä Installation Test Summary"
          echo ""
          echo "## Individual Extras"
          echo "| Job | Runner | Installer | Validation | Status |"
          echo "|-----|--------|-----------|------------|--------|"
          echo "| CPU Extras | CPU | pip | Install+Import | ${{ needs.cpu-install-test.result == 'success' && '‚úÖ' || '‚ùå' }} |"
          echo "| CPU Extras | CPU | uv | Install+Import | ${{ needs.cpu-install-test.result == 'success' && '‚úÖ' || '‚ùå' }} |"
          echo "| GPU Extras | CPU | pip | Install Only | $([[ $GPU_PIP_STATUS == 'success' ]] && echo '‚úÖ' || echo '‚ùå (expected)') |"
          echo "| GPU Extras | CPU | uv | Install Only | $([[ $GPU_UV_STATUS == 'success' ]] && echo '‚úÖ' || echo '‚ùå') |"
          echo ""
          echo "## ALL Extras (Combined)"
          echo "| Job | Runner | Validation | Status |"
          echo "|-----|--------|------------|--------|"
          echo "| ALL (pip/uv, Py3.10/3.12) | CPU | Install Only | ${{ needs.all-install-only-test.result == 'success' && '‚úÖ' || '‚ö†Ô∏è (expected)' }} |"
          echo "| ALL (uv, Py3.12) | **GPU** | **Install+Import** | ${{ needs.all-install-import-test.result == 'success' && '‚úÖ' || '‚ùå' }} |"
          echo ""
          
          # Core tests: CPU extras, GPU extras (uv), and ALL extras (uv) must pass
          if [ "${{ needs.cpu-install-test.result }}" != "success" ] || \
             [ "$GPU_UV_STATUS" != "success" ] || \
             [ "${{ needs.all-install-import-test.result }}" != "success" ]; then
            echo "‚ùå Core installation tests failed"
            exit 1
          else
            echo "‚úÖ All required tests passed (uv)"
          fi

