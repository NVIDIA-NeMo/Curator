# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow verifies that the basic install works across all supported platforms.
# Tests lock file installation (reproducible builds) and pip installation (user experience).

name: Installation Test

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"
  schedule:
    - cron: 0 0 * * *

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.event.label.name || 'main' }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  UV_HTTP_TIMEOUT: 60

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.docs_only.outputs.main == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Get changed files
        id: changed-files
        uses: step-security/changed-files@v45.0.1
        with:
          files: |
            nemo_curator/**
            .github/**
            pyproject.toml
            uv.lock
            docker/**
          base_sha: HEAD~1

      - name: Check if docs only
        shell: bash
        id: docs_only
        env:
          DOCS_ONLY: ${{ steps.changed-files.outputs.any_changed == 'false' }}
        run: |
          echo "main=$DOCS_ONLY" | tee -a "$GITHUB_OUTPUT"

  uv-lock-file-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: UV Lock File - Python${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up uv with Python ${{ matrix.python-version }}
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set environment variables
        run: |
          echo "UV_PROJECT_ENVIRONMENT=./venv" | tee -a "$GITHUB_ENV"
          echo "UV_LINK_MODE=copy" | tee -a "$GITHUB_ENV"

      - name: Test lock file installation (containers & source)
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "üß™ Testing lock file installation with Python ${{ matrix.python-version }}"
          echo "This ensures reproducible builds using uv.lock"
          
          # Test lock file installation with CPU-only extras to avoid CUDA dependencies on CPU runners
          # The Dockerfile uses --extra all, but that requires CUDA which isn't available on ubuntu-latest
          uv sync --link-mode copy --locked --extra audio_cpu --extra text_cpu --extra video_cpu --all-groups
          
          # Verify installation
          uv run python -c "from nemo_curator import package_info; print(f'‚úÖ nemo_curator version: {package_info.__version__}')"
          
          echo "‚úÖ Lock file installation successful"

      - name: Verify installation
        shell: bash -x -e -u -o pipefail {0}
        run: |
          uv run python -c "import nemo_curator; print('‚úÖ nemo_curator imported successfully')"
          uv run python -c "from nemo_curator import package_info; print(f'‚úÖ Package info: {package_info.__version__}')"

  uv-python310-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: UV + Python3.10 Installation Check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up uv with Python 3.10
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.10"

      - name: Set environment variables
        run: |
          echo "UV_PROJECT_ENVIRONMENT=./venv" | tee -a "$GITHUB_ENV"
          echo "UV_LINK_MODE=copy" | tee -a "$GITHUB_ENV"

      - name: Install with uv + Python 3.10
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "üß™ Testing uv + Python 3.10 installation"
          # Use CPU-only extras to avoid CUDA dependencies on CPU runners
          # This matches the pattern used in cicd-main.yml line 181
          uv sync --link-mode copy --locked --extra audio_cpu --extra text_cpu --extra video_cpu --all-groups
          
          # Verify Python version after sync
          uv run python --version
          uv run python -c "import sys; assert sys.version_info[:2] == (3, 10), f'Expected Python 3.10, got {sys.version_info[:2]}'"
          echo "‚úÖ Python 3.10 verified"
          
          # Verify installation
          uv run python -c "import nemo_curator; print('‚úÖ Installation successful with uv + Python 3.10')"

  pip-install-test:
    needs: [pre-flight]
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true')
    runs-on: ubuntu-latest
    name: Pip Install - Python${{ matrix.python-version }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        shell: bash -x -e -u -o pipefail {0}
        run: |
          python -m pip install --upgrade pip

      - name: Install nemo_curator via pip
        shell: bash -x -e -u -o pipefail {0}
        run: |
          echo "üß™ Testing pip install nemo_curator"
          echo "This resolves dependencies at runtime and catches user issues"
          
          # Install the package via pip (this is what users will do)
          pip install --no-cache-dir .
          
          echo "‚úÖ pip install completed"

      - name: Verify pip installation
        shell: bash -x -e -u -o pipefail {0}
        run: |
          python -c "import nemo_curator; print('‚úÖ nemo_curator imported successfully')"
          python -c "from nemo_curator import package_info; print(f'‚úÖ Package info: {package_info.__version__}')"
          
          # Verify pip can find the package
          pip show nemo-curator

  install-test-summary:
    needs: [pre-flight, uv-lock-file-test, uv-python310-test, pip-install-test]
    runs-on: ubuntu-latest
    name: Install test summary
    if: |
      (
        needs.pre-flight.outputs.docs_only == 'true'
        || always()
      )
      && !cancelled()
    steps:
      - name: Get workflow result
        id: result
        shell: bash -x -e -u -o pipefail {0}
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.run_id }}
          SKIPPING_IS_ALLOWED: ${{ needs.pre-flight.outputs.docs_only == 'true' }}
        run: |
          FAILED_JOBS=$(gh run view $GITHUB_RUN_ID --json jobs --jq '[.jobs[] | select(.status == "completed" and .conclusion != "success")] | length') || echo 0

          if [ "${FAILED_JOBS:-0}" -eq 0 ] || [ "$SKIPPING_IS_ALLOWED" == "true" ]; then
              echo "‚úÖ All installation tests completed successfully"
              exit 0
          else
              echo "‚ùå Found $FAILED_JOBS failed installation test(s)"
              # Show which jobs failed
              gh run view $GITHUB_RUN_ID --json jobs --jq '.jobs[] | select(.status == "completed" and .conclusion != "success") | .name'
              exit 1
          fi

